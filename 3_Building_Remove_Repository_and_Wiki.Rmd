---
title: "3 Building Remote Repository and Wiki"
output:
  html_document:
    df_print: paged
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      message = FALSE,
                      cache = FALSE)


```

# Summary

The following code attempts to create the remote repository for the live, public store. It then reads this store and creates the wiki

# Environment

Python and the Synapse python library will need to be setup in the environment. Other variables and R libraries are fully configured here. Enter your username and password for Synapse.org.

```{r Setting Environment}
#Needed Libraries 
# Setup loop to check in library is installed....
#library(synapser) #Synapse API
#library(knitr) #command line option in compiling notebook
#library(tools)
#library(xlsx) #read xmls files
#library(data.table) 
#library(reticulate) #Python integration into R studio
#library(stringr) #parse strings
source("./CustomFunctions.R")

#library(PythonInR) #required to use some of sysapse API

#some libraries are used from python
synapseclient <- import('synapseclient')
synapseutils <- import('synapseutils') 

#Constants
#File locations and directories
DATADIRECTORY <- "./Data/"
STAGINGAREA <- paste(DATADIRECTORY, "New/", sep = "")
REPORTDIRECTORY <- "./Reports/3_"


SYNLOGIN <- synapseclient$login() #generate synology login token
```

# Mirror Local Staging Area to Remote Repository

```{r}

#build a manifest
listedFiles <- list.files("./Data/New/")
listedFiles <- paste("./Data/New/", listedFiles, sep= "")
Manifest <- data.frame(path = as.character(listedFiles),
                       stringsAsFactors = FALSE)


Manifest$parent <- rep("syn10848316",nrow(Manifest))
Manifest$name <- basename(Manifest$path)
write.table(Manifest, file=paste(REPORTDIRECTORY, "manifest.tsv", sep = ""), quote=FALSE, sep='\t')

synapseutils$sync$syncToSynapse(SYNLOGIN, manifestFile = paste(REPORTDIRECTORY, "manifest.tsv", sep = ""), dryRun = FALSE)

```


# Build Wiki

syn10848316 - project

```{r}



#generate description of overal volume of data for top of data information wiki subpages
sink("./Data/WikiPages/Data Description.txt")
  cat("\n")
  cat("## Data Frequency and Availability \n")
  print(kable(FileInformationPrivatized, row.names = FALSE))
  cat("\n")
sink()

#list of filenames/data types to create wiki pages for
namedMatched <- c("Passive Features","PHQ-2","PHQ-9","Study Metadata","QoL Impact","GAD-7","Health App","General Mental Health","PGIC","Sleep")

for (i in 1:length(namedMatched)) {
  print(namedMatched[i])
  #temp1 <- find.data(as.character(FileInformation[FileInformation$synID == as.character(MatchedRecords[i,"V1SynID"]),]$path))
  path <- paste("./Data/WikiPages/",namedMatched[i],".txt", sep = "")
  #temp2 <- find.data(as.character(FileInformation[FileInformation$synID == as.character(MatchedRecords[i,"V2SynID"]),]$path))
  sink(path)
  
  #Print Front Matter
  if (file.exists(paste("./Data/WikiPages/Texts/",namedMatched[i],".txt", sep = ""))) {
    cat(paste(readLines(paste("./Data/WikiPages/Texts/",namedMatched[i],".txt", sep = "")), collapse = "\n"))
    cat("\n\n")
  }
  
  #for (j in c("temp1","temp2")) {
  for (l in c("V1SynID","V2SynID")) {
    #print(paste("step",j, sep = " "))
    #j <- get(j)
    #j <- find.data(as.character(FileInformation[FileInformation$synID == as.character(MatchedRecords[i,l]),]$path))
    j <- as.character(FileInformation[FileInformation$synID == as.character(MatchedRecords[i,l]),]$path)
    wiki <- build.wiki.data.description(j)
    
    
    cat(paste("## ",
                substring(l,1,2), 
                " - ",
                namedMatched[i], 
                " Data Dictionary", 
                sep = ""))
    
    cat("\n")
    
    cat(paste("(", basename(j), " - ", as.character(MatchedRecords[i,l]),")", sep = ""))
    cat("\n\n")
              
    wiki$Description <- NULL
    print(kable(wiki, caption = "test", row.names = FALSE))
    cat("\n<br> <br>\n")
    cat("## Provenance \n\n")
    cat(paste("${provenance?entityList=",
            as.character(MatchedRecords[i,l]),
            "&depth=1&showExpand=false}", 
            sep = ""))
    cat("\n")
    
  }
  sink()
  #temp2 <- find.data(as.character(FileInformation[FileInformation$synID == as.character(MatchedRecords[i,"V2SynID"]),]$path))
}

unmatchedFiles <- c("alcoholuse_403.xls","apps_399.xls","sds_brighten_v2.tsv","calls.csv","messages.csv")
namedUnmatched <- c("Alcohol Use","Application Use", "Symptom Quality of Life", "Calls", "Messaging")

for (i in 1:length(namedUnmatched)) {
  print(namedUnmatched[i])
  #temp1 <- find.data(as.character(FileInformation[FileInformation$synID == as.character(MatchedRecords[i,"V1SynID"]),]$path))
  
  path <- paste("./Data/WikiPages/",namedUnmatched[i],".txt", sep = "")
  #temp2 <- find.data(as.character(FileInformation[FileInformation$synID == as.character(MatchedRecords[i,"V2SynID"]),]$path))
  sink(path)
  
    #Print Top Matter
  if (file.exists(paste("./Data/WikiPages/Texts/",namedUnmatched[i],".txt", sep = ""))) {
    cat(paste(readLines(paste("./Data/WikiPages/Texts/",namedUnmatched[i],".txt", sep = "")), collapse = "\n"))
    cat("\n\n")
  }
  #for (j in c("temp1","temp2")) {
  j <- as.character(FileInformation[FileInformation$fileName == unmatchedFiles[i],]$path)
  wiki <- build.wiki.data.description(j)
  
  cat(paste("## ",
              namedUnmatched[i], 
              " Data Dictionary", 
              sep = ""))
  
  cat("\n")

  cat(paste("(", basename(j), " - ", as.character(MatchedRecords[i,l]),")", sep = ""))
  cat("\n\n")
  
  wiki$Description <- NULL
  print(kable(wiki, caption = "test", row.names = FALSE))
  cat("\n<br> <br>\n")
  cat("## Provenance \n\n")
  cat(paste("${provenance?entityList=",
            as.character(FileInformation[FileInformation$fileName == unmatchedFiles[i],]$synID),
            "&depth=1&showExpand=false}", 
            sep = ""))
  cat("\n")
  

    
  
  sink()
  #temp2 <- find.data(as.character(FileInformation[FileInformation$synID == as.character(MatchedRecords[i,"V2SynID"]),]$path))
}

```


```{r}

workingProject <- "syn10848316"
toUpload <- c(namedMatched,namedUnmatched)

#delete current wiki
wikiHeaders <-SYNLOGIN$getWikiHeaders(workingProject)
SYNLOGIN$delete(obj = paste(workingProject,"/wiki/",wikiHeaders[[1]]$id, sep = ""))

#create new wiki and record its ID
wikiHolder <- synapseclient$wiki$Wiki(title = "BRIGHTEN Study Public Researcher Portal", owner = workingProject)
wikiHolder$markdown <- paste(readLines("./Data/WikiPages/Texts/Front.txt"), collapse = "\n")
SYNLOGIN$store(wikiHolder)

wikiHeaders <- SYNLOGIN$getWikiHeaders(workingProject)
wikiTop <- wikiHeaders[[1]]$id

#wikiHolder <- synapseclient$wiki$Wiki(title = "Accessing Data", owner = workingProject, parentWikiId = wikiTop)
#SYNLOGIN$store(wikiHolder)

#wikiHolder <- synapseclient$wiki$Wiki(title = "Accessing Data", owner = #workingProject, parentWikiId = wikiTop)
#SYNLOGIN$store(wikiHolder)

wikiHolder <- synapseclient$wiki$Wiki(title = "Data Description", owner = workingProject, parentWikiId = wikiTop)

wikiHolder$markdown <- paste(readLines("./Data/WikiPages/Data Description.txt"), collapse = "\n")

#wikiHolder$markdown <- paste("\n",kable(FileInformationPrivatized, row.names = FALSE), "\n", sep = "", collapse = "" )

SYNLOGIN$store(wikiHolder)

wikiHeaders <- SYNLOGIN$getWikiHeaders(workingProject)
wikiData <- wikiHeaders[[2]]$id
#generate Data Description pages

for(i in 1:length(toUpload)) {
  print(toUpload[i])
  #scan(paste("./Data/WikiPages/",toUpload[i],".txt", sep = ""))
  wikiMarkdown <- paste(readLines(paste("./Data/WikiPages/",toUpload[i],".txt", sep = "")), collapse = "\n")
  wikiHolder <- synapseclient$wiki$Wiki(title = paste(toUpload[i], sep = ""), owner = workingProject, parentWikiId = wikiData, markdown = wikiMarkdown)
  SYNLOGIN$store(wikiHolder)
}

```

the above pages should be enhanced to include study information? or should that be elsehwere?


other potential wiki pages

accessing brighten data


