---
title: "1 - Description of Initially Available Data"
output: html_notebook
---

# Summary

A report of data quality necessary for planing of ETL activities for generation of a final and public repository of BRIGHTEN reserach data. Original files, their version, synapse ID, name, and contained variables are described in part 1. In part 2 all variables are described by the synapse ID of thier containing file, data type, frequency of subjects, frequency of tasks, mean, and standard deviation

# Environment

Python and the Synapse python library will need to be setup in the environment. Other variables and R libraries are fully configured here. Enter your username and password for Synapse.org.

```{r Setting Environment}
#Needed Libraries 
# Setup loop to check in library is installed....
#library(synapser) #Synapse API
library(knitr)
library(tools)
library(xlsx)
library(reticulate) #Python integration into R studio


#library(PythonInR) #required to use some of sysapse API

#some libraries are used from python
synapseclient <- import('synapseclient')
synapseutils <- import('synapseutils') 

#Constants
#File locations and directories
DATADIRECTORY <- "../Data/"

SYNLOGIN <- synapseclient$login() #generate synology login token
```

# Loading Custom Functions

The following functions for working with our data are constructed and loaded here:

```{r}

#PRE string identifying volume label content, and synapse file description object (can be list)
#POST data frame describing the variables in each file named in the synapse object.
simple.content.listing <- function(VOL, INFO) {
  output <- data.frame(volume = character(),
                     synID = character(),
                     fileName = character(),
                     variables = character(),
                     stringsAsFactors = FALSE)
   `%!in%` <- Negate('%in%')
                    
  for(i in 1:(length(INFO))) {
    print(i)
    extension <- tools::file_ext(INFO[[i]]$files)
    if(extension == "tsv"| extension == "txt") {
      temp <-as.data.frame(fread(INFO[[i]]$path)) #read.table(INFO[[i]]$path, sep = "\t",  header = TRUE)
    }
    if(extension == "csv") {
      temp <- read.csv(INFO[[i]]$path, header = TRUE)
    }
    if(extension == "xls" | extension == "xlsx") {
      temp <- xlsx::read.xlsx(INFO[[i]]$path, sheetIndex = 1)
    }  
    if(!exists("temp")) {
      temp <- "file read error"
    }
    
    output[i,] <- c(VOL,
                    INFO[[i]]$properties$id,
                    INFO[[i]]$files,
                    paste(names(temp), collapse = ", "))
  }
   return(output)
}

custom.counter <- function(VOL, SID, DESC, USERS, DF) {
  #construct an empty dataframe meeting specifications
  toExport <- data.frame(volume = character(),
                         synID = character(),
                         description = character(),
                         userCount = numeric(),
                         uniqueObs = numeric())
  if(nrow(DF) > 0) {
    for (i in 1:ncol(DF)) {
      toExport[i,] <- c(VOL, 
                        SID,
                        DESC,
                        nrow(unique(DF[,USERS])),
                        sum(unique(DF)))
    }
  }
  return(toExport)
}

```

# Extraction from Synapse

The BRIGHTEN repository was loaded into a local project directory and a variable list generated for each file.

```{r}

#there is an error when trying to pull the full repository, and this error is repeated when trying to pull just the V1 directory and its subdirectories. More specicifcally, it appears that hte bulk data pull throws an error when encountering WIKI files, as is found in the analysis directory. Skipping this directory (putting from the other two directories under V1) bypasses this problem.


V1aInformation <- synapseutils$syncFromSynapse(SYNLOGIN, entity = "syn10236537", path = paste(DATADIRECTORY,"original/V1/", sep = "") )

V1bInformation <- synapseutils$syncFromSynapse(SYNLOGIN, entity = "syn5908558", path = paste(DATADIRECTORY,"original/V1/", sep = "") )

V2Information <- synapseutils$syncFromSynapse(SYNLOGIN, entity = "syn9952129", path = paste(DATADIRECTORY,"original/V2/", sep = "") )

FileContents <- simple.content.listing("V1", V1aInformation)
FileContents <- rbind(FileContents, simple.content.listing("V1", V1bInformation))
FileContents <- rbind(FileContents, simple.content.listing("V2", V2Information))
      


FileContents


```




```{r}

FileInformation <- data.frame(version = character(),
                              synapseID = character(),
                              fileName = character(),
                              fileDescription = character(),
                              uniqueUsers = numeric(),
                              uniqueObservations = numeric(),
                              stringsAsFactors = FALSE)

requiredV1IDs <- c("syn10236547",
                   "syn10236538",
                   "syn10236539",
                   "syn10236540",
                   "syn10082863",
                   "syn10250483", 
                   "syn10250484", 
                   "syn10250487", 
                   "syn10250488", 
                   "syn10250489", 
                   "syn10250490", 
                   "syn10250491", 
                   "syn10250493", 
                   "syn10250494")

for(i in requiredV1IDs) {
  temp <- SYNLOGIN$get(i, downloadLocation = paste(DATADIRECTORY,"original/V1/", sep = ""))
  FileInformation[i,] <- c("v1",
                           i,
                           temp$files,
                           NA,
                           NA,
                           NA)
}


requiredV2IDs <- c("syn11687434",
                   "syn10165199",
                   "syn10149532",
                   "syn10164248",
                   
                   

```

Summary data are reported for the following files

Volume |File Name              | SynID        
-------|-----------------------|-------------
V1     |`r V1a$files`          |syn10236547
V1     |`r V1b$files`          |syn10236538
v1     |`r V1c$files`          |Syn10236539
V1     |`r V1d$files`          |Syn10236540
v1     |`r V1e$files`          |Syn10082863
v1     |`r V1f$files`          |Syn10250483
v1     |`r V1g$files`          |Syn10250484
v1     |`r V1h$files`          |Syn10250487
v1     |`r V1i$files`          |Syn10250488
v1     |`r V1j$files`          |Syn10250489
v1     |`r V1k$files`          |Syn10250490
v1     |`r V1l$files`          |Syn10250491
v1     |`r V1m$files`          |Syn10250493
v1     |`r V1n$files`          |Syn10250494

```{r}
syn10236547 <- read.table(paste(V1a$cacheDir, "/",V1a$files, sep =""), header = TRUE)
syn10236538 <- read.table(paste(V1b$cacheDir, "/",V1b$files, sep =""), header = TRUE)
```



