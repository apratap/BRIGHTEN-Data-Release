---
title: "1 - Description of Initially Available Data"
output:
  html_document:
    df_print: paged
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      message = FALSE,
                      cache = FALSE)


```

# Summary

A report of data quality necessary for planing of ETL activities for generation of a final and public repository of BRIGHTEN reserach data. Pulls data from origina synapse repository and generates 3 reports: variable names per file, list of matches between V1 and v2 files, and a report of username frequencies and unique observations in all files.

# Environment

Python and the Synapse python library will need to be setup in the environment. Other variables and R libraries are fully configured here. Enter your username and password for Synapse.org.

```{r Setting Environment}
#Needed Libraries 
# Setup loop to check in library is installed....
#library(synapser) #Synapse API
library(knitr) #command line option in compiling notebook
library(tools)
library(xlsx) #read xmls files
library(data.table) 
library(reticulate) #Python integration into R studio
library(stringr) #parse strings
source("../CustomFunctions.R") #custom functions for working with synapse and our data

#library(PythonInR) #required to use some of sysapse API

#some libraries are used from python
synapseclient <- import('synapseclient')
synapseutils <- import('synapseutils') 

#Constants
#File locations and directories
DATADIRECTORY <- "../Data/"
REPORTDIRECTORY <- "../Reports/Description of Initially Available Data/"

dir.create(DATADIRECTORY)
dir.create("../Reports/")
dir.create(REPORTDIRECTORY)

SYNLOGIN <- synapseclient$login() #generate synology login token

```

# Load Local Functions

These are convienence functions for processees in this notebook. Functions common to working with synapse and our datda in general can be found in ../CustomFunctons.R

```{r loading_custom_functons}

custom.counter <- function(VOL, SID, DESC, USERS, DF) {
  #construct an empty dataframe meeting specifications
  toExport <- data.frame(volume = character(),
                         synID = character(),
                         description = character(),
                         userCount = numeric(),
                         uniqueObs = numeric())
  if(nrow(DF) > 0) {
    for (i in 1:ncol(DF)) {
      toExport[i,] <- c(VOL, 
                        SID,
                        DESC,
                        nrow(unique(DF[,USERS])),
                        sum(unique(DF)))
    }
  }
  return(toExport)
}

#PRE: formated filecontents data frame, two synIDs or file names.
#POST: a list containing the synID, file name, and variables for each file
add.match <- function(MasterList, V1SynID = NA, V2SynID = NA, V1FileName = NA, V2FileName = NA, V1Variables = NA, V2Variables = NA){
  if(is.na(V1SynID) & !is.na(V1FileName)) {
    V1SynID <- MasterList[MasterList$fileName == V1FileName,]$synID
  }
  if(is.na(V2SynID) & !is.na(V2FileName)) {
    V2SynID <- MasterList[MasterList$fileName == V2FileName,]$synID  
  }
  if(is.na(V1FileName) & !is.na(V1SynID)) {
    V1FileName <- MasterList[MasterList$synID == V1SynID,]$fileName
  }
  if(is.na(V2FileName) & !is.na(V2SynID)) {
    V2FileName <- MasterList[MasterList$synID == V2SynID,]$fileName
  }
  if(!is.na(V1SynID)) {
    V1Variables <- MasterList[MasterList$synID == V1SynID,]$variables
  }
  if(!is.na(V2SynID)) {
    V2Variables <- MasterList[MasterList$synID == V2SynID,]$variables
  }
  return(c(V1SynID, V1FileName, V1Variables, V2SynID, V2FileName, V2Variables ))
}

```

# Extraction from Synapse

```{r pulling data from repository}

#there is an error when trying to pull the full repository, and this error is repeated when trying to pull just the V1 directory and its subdirectories. More specicifcally, it appears that hte bulk data pull throws an error when encountering WIKI files, as is found in the analysis directory. Skipping this directory (putting from the other two directories under V1) bypasses this problem.

V1aInformation <- synapseutils$syncFromSynapse(SYNLOGIN, entity = "syn10236537", path = paste(DATADIRECTORY,"original/V1/", sep = "") )

V1bInformation <- synapseutils$syncFromSynapse(SYNLOGIN, entity = "syn5908558", path = paste(DATADIRECTORY,"original/V1/", sep = "") )

V2Information <- synapseutils$syncFromSynapse(SYNLOGIN, entity = "syn9952129", path = paste(DATADIRECTORY,"original/V2/", sep = "") )
```

The BRIGHTEN repository was loaded into a local project directory. This directory "../original/." contains two subdirectories, one for each volume of data provided ("V1", "V2"). We ultimately want to create a single unified volume but need an accurate description of the data in order to build an unified schema and data set.

# Reporting files and their headers

```{r describing file columns}
FileContents <- simple.content.listing("V1", V1aInformation)
FileContents <- rbind(FileContents, simple.content.listing("V1", V1bInformation))
FileContents <- rbind(FileContents, simple.content.listing("V2", V2Information))
 
write.csv(FileContents[,!(names(FileContents) %in% "path")], paste(REPORTDIRECTORY, "OriginalFileContents.csv", sep = ""))   

toShow <- data.frame("Variable" = names(FileContents),
                     "Data Type" = as.character(sapply(FileContents, typeof)),
                     "Description" = c("Study volume indicator",
                                        "Synapse ID",
                                        "Local Path (not exported)",
                                        "File name",
                                        "comma seperated list of all variables contained in file"),
                      stringsAsFactors = FALSE,
                     check.names = FALSE)

```

We generate a simple description of file contents and save it to our reports folder `r REPORTDIRECTORY`.

kable(toShow, caption = "Report Description")

# Reporting Matching of V1 and V2 Data

```{r}
MatchedRecords <- data.frame(V1SynID = character(),
                          V1FileName = character(),
                          V1Variables = character(),
                          V2SynID = character(),
                          V2FileName = character(),
                          V2Variables = character(),
                          stringsAsFactors = FALSE)

#PRE: a synID and or a file name of two different files to be matched
#POST: a list ocntaining both a synID and a file name for both files


MatchedRecords[nrow(MatchedRecords)+1,]<- add.match(FileContents, V1FileName =  "brighten_v1_passive_features.tsv", V2FileName = "passivedata_brighten_v2.tsv")
MatchedRecords[nrow(MatchedRecords)+1,]<- add.match(FileContents, V1FileName =  "brighten_v1_phq2_scores.tsv", V2FileName = "phq2_brighten_v2.tsv")
MatchedRecords[nrow(MatchedRecords)+1,]<- add.match(FileContents, V1FileName =  "brighten_v1_phq9_scores.tsv", V2FileName = "phq9_brighten_v2.tsv")
MatchedRecords[nrow(MatchedRecords)+1,]<- add.match(FileContents, V1FileName =  "brighten_v1_study_metadata.tsv", V2FileName = "mdata_brighten_v2.tsv")
MatchedRecords[nrow(MatchedRecords)+1,]<- add.match(FileContents, V1FileName =  "energylevels_404.xls", V2FileName = "impact.csv")          
MatchedRecords[nrow(MatchedRecords)+1,]<- add.match(FileContents, V1FileName =  "gad7_402.xls", V2FileName = "gad-7.csv")             
MatchedRecords[nrow(MatchedRecords)+1,]<- add.match(FileContents, V1FileName =  "healthapps_405.xls", V2FileName = "health app overview.csv")             
MatchedRecords[nrow(MatchedRecords)+1,]<- add.match(FileContents, V1FileName =  "mentalhealthservices_400.xls", V2FileName = "impact-mh.csv")   
MatchedRecords[nrow(MatchedRecords)+1,]<- add.match(FileContents, V1FileName =  "moodassessment_407.xls", V2FileName = "pgic.csv")        
MatchedRecords[nrow(MatchedRecords)+1,]<- add.match(FileContents, V1FileName =  "sleep_406.xls", V2FileName = "sleep.csv")

for (i in   FileContents[FileContents$synID %!in% MatchedRecords$V1SynID & FileContents$volume == "V1",]$synID) {
  MatchedRecords[nrow(MatchedRecords)+1,] <- add.match(FileContents, V1SynID = i)
}


for (i in   FileContents[FileContents$synID %!in% MatchedRecords$V2SynID & FileContents$volume == "V2",]$synID) {
  MatchedRecords[nrow(MatchedRecords)+1,] <- add.match(FileContents, V2SynID = i)
}

#write matches to file for sharing
write.csv(MatchedRecords, paste(REPORTDIRECTORY, "MatchedRecords.csv", sep = ""))   


#create table to display data dictionary of report
toShow <- data.frame("Variable" = names(MatchedRecords),
                     "Data Type" = as.character(sapply(MatchedRecords, typeof)),
                     "Description" = c("Synology ID of file from V1",
                                        "Name of file from V1",
                                       "List of V1 File's Varaibles",
                                        "Synology ID of file from V2",
                                        "Name of file from V2",
                                       "List of V2 File's Variables"),
                      stringsAsFactors = FALSE,
                     check.names = FALSE)

write.csv(MatchedRecords, paste(REPORTDIRECTORY, "MatchedRecords.csv", sep = ""))  

```

A report of currently matched V1 and V2 files is generated and save to our reports folder.

kable(toShow, caption = "Report Description")

## Reporting files and number of observations

```{r describing file volumes}

FileInformation <- FileContents
#ceate new columns as indicator variables fo rthe existense of each ID variable type
ids <- c("brightenid","user_id","username","Username","Response ID")
for (i in ids) {
  FileInformation[,i] <- 0
}

#assign indicator of 0 or 1
for(i in ids) {
  for(j in 1:nrow(FileInformation)) {
    if(str_detect(FileInformation[j,"variables"], i)) {
      FileInformation[j,i] <- 1
    }
  }
}

#add a column to total unique observations in data
FileInformation$uniqueObservations <- 0
FileInformation$N <- 0

#laod data and, if indicator is 1, replace it with how many unique observations were made of that variable, count number of totally unique rows
for (i in 1:nrow(FileInformation)) {

  retrievedData <- find.data(FileInformation[i,]$path)
  FileInformation[i,]$uniqueObservations <- nrow(unique(retrievedData))
  FileInformation[i,]$N <- nrow(retrievedData)
  for (IDName in ids) {
    if (FileInformation[i,IDName] == 1) {
      FileInformation[i,IDName] <- length(unique(retrievedData[,IDName]))

    }

  }
}



#calculate mean number of observations per user and the SD
FileInformation$brightenidSD <- 0
FileInformation$userIDSD <- 0
FileInformation$brightenidMeanObs <- 0
FileInformation$userIDMeanObs <- 0

for (i in 1:(nrow(FileContents))) {
  temp <- find.data(FileInformation[i,]$path)
  maxTest <- max(FileInformation[i,ids[-1]])
  if(maxTest > 0) {
    for(j in ids[-1]) {
      if (FileInformation[i, j] == maxTest) {
        print(i)
        print(j)
        FileInformation[i,]$userIDMeanObs <- mean(aggregate(list(temp[,j]), list(paste(temp[,j])), FUN = length)[[2]], na.rm = TRUE)
        FileInformation[i,]$userIDSD <- sd(aggregate(list(temp[,j]), list(paste(temp[,j])), FUN = length)[[2]], na.rm = TRUE)
      }
    }
  }
  if (FileInformation[i,"brightenid"] > 0) {
    temp <- find.data(FileInformation[i,]$path)
    FileInformation[i,]$brightenidMeanObs <- mean(aggregate(paste(brightenid)~brightenid, temp, length)[[2]], na.rm=TRUE)
    FileInformation[i,]$brightenidSD <- sd(aggregate(paste(brightenid)~brightenid, temp, length)[[2]], na.rm = TRUE)
  }
}




#Merge User Count columns
FileInformation$userID <- apply(FileInformation[,c("user_id","username","Username","Response ID")],1, "max")

#formatting SD
FileInformation$brightenidCI <- NA
FileInformation$userIDCI <- NA
FileInformation$brightenidMeanSD <- paste(round(FileInformation$brightenidMeanObs),
                                      " ± ",
                                      round(FileInformation$brightenidSD),
                                      sep = "")

FileInformation$userIDMeanSD <- paste(round(FileInformation$userIDMeanObs),
                                  " ± ",
                                  round(FileInformation$userIDSD), 
                                  sep = "")


#Dont show these:
# "path","variables","user_id","username","Username","Response ID"

FileInformationPrivatized <- FileInformation[,c("volume","synID","fileName","brightenid","userID","N","userIDMeanSD","brightenidMeanSD")]

#writefile showing frequencies
write.csv(FileInformationPrivatized, paste(REPORTDIRECTORY, "FileInformation.csv", sep = ""))   


#create table to display data dictionary of report
toShow <- data.frame("Variable" = names(FileInformationPrivatized),
                     "Data Type" = as.character(sapply(FileInformationPrivatized, typeof)),
                     "Description" = c("Study volume indicator",
                                        "Synology ID",
                                        "File name",
                                        "Frequency of unique 'brightenid'",
                                        "Frequency of other user IDs",
                                        "Frequency of observations",
                                        "Mean number of observations per other user ID",
                                       "Mean number of observations per brighten ID"),
                      stringsAsFactors = FALSE,
                     check.names = FALSE)


```

A report of user name frequencies is generated and saved. Its data dictionary is below.

kable(toShow, caption = "Report Description")